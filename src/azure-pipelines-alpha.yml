variables:
- name: BuildParameters.RestoreBuildProjects
  value: 'src/DotNetBrightenerFramework.sln'
- name: BuildConfiguration
  value: Release
name: $(date:yyyyMMdd)$(rev:.r)
trigger: none 
pr:
  branches:
    include:
    - release/alpha
jobs:
- job: Building_Alpha_Release
  displayName: Running on self-hosted agent
  pool:
    name: dotnetbrightener-selfhosted
    demands: 
    - agent.name -equals self-hosted
  steps:
  - checkout: self
    submodules: true
  - task: UseDotNet@2
    displayName: Use .NET Core sdk 8.x
    inputs:
      version: 8.x
      performMultiLevelLookup: true
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: $(BuildParameters.RestoreBuildProjects)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: -p:GeneratePackageOnBuild=false --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: --configuration $(BuildConfiguration) -p:VerSuf=$(version.suffix)$(Build.BuildId)
  - task: ArchiveFiles@2
    displayName: Archive files
    inputs:
      rootFolderOrFile: 'src/nupkg_release'
      includeRootFolder: true
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
      replaceExistingArchive: true
  - task: NuGetCommand@2
    displayName: Push to Nuget
    inputs:
      command: 'push'
      packagesToPush: 'src/nupkg_release/*.nupkg'
      nuGetFeedType: 'external'
      publishFeedCredentials: 'DotNetBrightener Nuget'