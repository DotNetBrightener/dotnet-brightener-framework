variables:
- name: BuildParameters.RestoreBuildProjects
  value: 'src/DotNetBrightenerFramework.sln'

- name: BuildConfiguration
  value: Release

- name: ExtractedBuildNo
  value: $[replace(replace(variables['System.PullRequest.targetBranchName'], 'release/', ''), 'preview/', '')]


name: $(ExtractedBuildNo)-preview-$(Rev:r)

trigger: none 

jobs:
- job: Build_Packages
  displayName: Building with self-hosted agent
  pool:
    name: dotnetbrightener-selfhosted
    demands: 
    - agent.name -equals self-hosted
  steps:
  - checkout: self
    displayName: Checking out $(Build.BuildNumber)
    submodules: true
    persistCredentials: true

  - task: UseDotNet@2
    displayName: Ensure .NET Core SDK Installed
    inputs:
      version: 8.x
      performMultiLevelLookup: true

  - task: DotNetCoreCLI@2
    displayName: Restore Packages
    inputs:
      command: restore
      projects: $(BuildParameters.RestoreBuildProjects)

  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: -p:GeneratePackageOnBuild=false --configuration $(BuildConfiguration)

  - task: DotNetCoreCLI@2
    displayName: Building version $(Build.BuildNumber)
    inputs:
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: --configuration $(BuildConfiguration) -p:Version=$(Build.BuildNumber)
  
  - task: PublishBuildArtifacts@1
    displayName: "Archiving Artifact"
    inputs:
      PathtoPublish: 'src/nupkg_release'
      ArtifactName: 'dnb-framework'
      publishLocation: 'Container'